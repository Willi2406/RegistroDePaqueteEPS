@inherits LayoutComponentBase
@using MudBlazor
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavManager

<MudPopoverProvider/>
<MudDialogProvider/>
<MudSnackbarProvider/>

<div class="page">
    <header class="top-header">
        <div class="logo-container">
            <img src="/Imagenes/EPS_Barra_Superior.png" alt="EPS Logo" class="logo-img" />
        </div>

        <div class="header-title-container">
            <SectionOutlet SectionName="TituloPagina" />
        </div>

        <AuthorizeView Roles="Cliente">
            <Authorized>
                <div class="user-header-info" @onclick="TogglePerfil">
                    <div class="text-right">
                        <span class="user-name-text">@NombreUsuario</span>
                        <br />
                        <span class="user-code-text">@CodigoEPS</span>
                    </div>
                    <i class="bi bi-person-fill user-header-icon"></i>
                </div>
            </Authorized>
        </AuthorizeView>

        @if (mostrarPopup)
        {
            <div class="profile-overlay" @onclick="CerrarPerfil"></div> <div class="profile-card animate-fade-in">
                <i class="bi bi-person-fill profile-avatar-icon"></i>
                <h3 class="profile-name">@NombreUsuario</h3>
                <h4 class="profile-code">@CodigoEPS</h4>
                <p class="profile-branch">EPS @Sucursal</p>

                <div class="address-grid">
                    <div class="address-box">
                        <div class="addr-title">Dirección de Paquetes</div>
                        <div class="addr-content">
                            8298 NW 21st St<br/>
                            APT @CodigoEPS<br/>
                            Doral, FL 33122-0002
                        </div>
                    </div>
                    <div class="address-box">
                        <div class="addr-title">Dirección de Correspondencia</div>
                        <div class="addr-content">
                            P.O BOX 025650<br/>
                            APT @CodigoEPS<br/>
                            MIAMI, FL 33102-5650
                        </div>
                    </div>
                </div>

                <div class="action-icons-row">
                    <a href="/sucursales" class="icon-action">
                        <i class="bi bi-shop"></i>
                        <span>Sucursales</span>
                    </a>
                    <a href="/faq" class="icon-action">
                        <i class="bi bi-question-circle-fill"></i>
                        <span>Preguntas<br>Frecuentes</span>
                    </a>
                    <a href="/tutoriales" class="icon-action">
                        <i class="bi bi-display"></i>
                        <span>Tutoriales</span>
                    </a>
                </div>

                <form action="Account/Logout" method="post">
                    <input type="hidden" name="ReturnUrl" value="" />
                    <button type="submit" class="btn-logout">
                        Cerrar Sesión
                    </button>
                </form>
            </div>
        }
    </header>

    <div class="main-container">
        <main class="content">
            <div class="content-body">
                @Body
            </div>
            
            <div class="layout-footer d-flex justify-content-between">
                <div class="copyright-text">
                    EPS, Todos los Derechos Reservados
                </div>
                <div>
                    <a href="#" class="footer-link">Terminos, condiciones y politica de privacidad</a>
                </div>
            </div>
        </main>
        
        <aside class="sidebar-container">
            <NavMenu />
        </aside>
    </div>
</div>

@code {
    private bool mostrarPopup = false;
    
    // Variables para mostrar datos
    private string NombreUsuario = "Cargando...";
    private string CodigoEPS = "---";
    private string Sucursal = "Principal"; 

    protected override async Task OnInitializedAsync()
    {
        // 1. Obtenemos el estado de autenticación
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userPrincipal = authState.User;

        if (userPrincipal.Identity != null && userPrincipal.Identity.IsAuthenticated)
        {
            var appUser = await UserManager.GetUserAsync(userPrincipal);

            if (appUser != null)
            {
                // 3. Asignamos los valores reales de la BD
                NombreUsuario = appUser.NombreCompleto ?? userPrincipal.Identity.Name;
                CodigoEPS = appUser.UserName; // Asumiendo que el UserName es el código (ej. 064-000824)
                Sucursal = appUser.Municipio ?? "Salcedo"; // Usamos Municipio como sucursal por defecto
            }
        }
    }

    private void TogglePerfil()
    {
        mostrarPopup = !mostrarPopup;
    }

    private void CerrarPerfil()
    {
        mostrarPopup = false;
    }
}