@page "/paquetesusuario"
@inject PaquetesService paquetesService
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@rendermode InteractiveServer

<SectionContent SectionName="TituloPagina">
    <h1>PAQUETES</h1>
</SectionContent>

<div class="glass-container">

    <AuthorizeView Roles="Admin">
        <Authorized>
            <div class="top-actions">
                <a href="/paquetesusuario/create" class="btn-new">
                    <i class="bi bi-plus-lg"></i> Agregar Paquete
                </a>
            </div>
        </Authorized>
    </AuthorizeView>

    <div class="table-header-row">
        <div class="col-cell"># Recepción</div>
        <div class="vertical-line"></div>
        <div class="col-cell">Fecha</div>
        <div class="vertical-line"></div>
        <div class="col-cell wide"># Tracking</div>
        <div class="vertical-line"></div>
        <div class="col-cell">Suplidor</div>
        <div class="vertical-line"></div>
        <div class="col-cell">Contenido</div>
        <div class="vertical-line"></div>
        <div class="col-cell small">Peso</div>
        <div class="vertical-line"></div>
        <div class="col-cell">Estatus</div>
        <div class="vertical-line"></div>
        <div class="col-cell">Total</div>
        <div class="vertical-line"></div>
        <div class="col-cell">Condición</div>
    </div>

    <div class="rows-container">
        @if (ListaPaquetes.Count == 0)
        {
            <div class="data-row justify-content-center">
                <span class="text-muted">No hay paquetes registrados.</span>
            </div>
        }
        else
        {
            @foreach (Paquetes paquete in ListaPaquetes)
            {
                <div class="data-row justify-content-center">

                    <div class="col-cell">
                        <button type="button" class="btn-recepcion-link"
                                @onclick="() => AbrirModalEdicion(paquete)"
                                @onclick:stopPropagation="true">
                            @paquete.NumeroRecepcion
                        </button>
                    </div>
                    <div class="vertical-line"></div>

                    <div class="col-cell">@DateTime.Now.ToString("dd/MM/yyyy")</div>
                    <div class="vertical-line"></div>
                    <div class="col-cell wide">@paquete.NumeroTracking</div>
                    <div class="vertical-line"></div>
                    <div class="col-cell">@paquete.Suplidor</div>
                    <div class="vertical-line"></div>
                    <div class="col-cell">@paquete.Contenido</div>
                    <div class="vertical-line"></div>
                    <div class="col-cell small">@paquete.Peso lb</div>
                    <div class="vertical-line"></div>
                    <div class="col-cell" style="color:@GetStatusColor("Disponible")"></div>
                    <div class="vertical-line"></div>
                    <div class="col-cell">US$ @paquete.Total</div>
                    <div class="vertical-line"></div>
                    <div class="col-cell">@(paquete.CondicionEspecial ? "Especial" : "Normal")</div>
                </div>
            }
        }
    </div>

</div>
@if (mostrarModalEdicion)
{
    <div class="modal-backdrop" @onclick="CerrarModal">
        <div class="modal-window-blue" @onclick:stopPropagation>

            <div class="eps-header">
                <img src="/Imagenes/EPS_Barra_Superior.png" alt="EPS Logo" />
                <button type="button" class="btn-recepcion-link" style="font-size:1.5rem;" @onclick="CerrarModal">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="eps-body-blue">
                <h3 style="border-bottom:1px solid rgba(255,255,255,0.3); padding-bottom:10px; margin-bottom:20px;">
                    Estatus Paquete
                </h3>
                <AuthorizeView Roles="Admin">
                    <Authorized>
                        <button type="button" @onclick="ActualizarPaquete" class="btn-new">Actualizar Paquete</button>
                    </Authorized>
                </AuthorizeView>
                
                <div class="table-header-row">
                    <div class="col-cell">Estatus</div>
                    <div class="vertical-line"></div>
                    <div class="col-cell">Fecha</div>
                </div>

                <div class="rows-container">
                    @foreach (EstatusPaqueteDetalles estatus in PaqueteEnEdicion.EstatusPaquete)
                    {
                        <div class="data-row justify-content-center">
                            <div class="col-cell" style="color:@GetStatusColor("Disponible")">@ListaEstatus.FirstOrDefault(t => t.EstatusPaqueteId == estatus.EstatusPaqueteId)?.Descripcion</div>
                            <div class="vertical-line"></div>
                            <div class="col-cell">@estatus.Fecha.ToString("dd/MM/yyyy hh:mm")</div>
                        </div>
                    }
                </div>

                <AuthorizeView Roles="Admin">
                    <Authorized>
                        <div class="modal-footer-actions">
                            <button type="button" class="btn-blue-cancel" @onclick="CerrarModal">Cancelar</button>
                            <button type="button" class="btn-blue-save" disabled=@actualizado @onclick="GuardarCambiosPaquete">Guardar Cambios</button>
                        </div>
                    </Authorized>
                </AuthorizeView>
            </div>
        </div>
    </div>
}

@code {
    public List<Paquetes> ListaPaquetes { get; set; } = new List<Paquetes>();
    public List<EstatusPaquete> ListaEstatus { get; set; }
    private ApplicationUser appUser;
    private bool actualizado = true;

    // --- VARIABLES MODAL ---
    private bool mostrarModalEdicion = false;
    private Paquetes PaqueteEnEdicion = new Paquetes();

    protected override async Task OnInitializedAsync()
    {
        await CargarPaquetes();
        ListaEstatus = await paquetesService.ListarEstatus();
    }

    private async Task CargarPaquetes()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userClaimsPrincipal = authState.User;

        if (userClaimsPrincipal.Identity.IsAuthenticated)
        {
            appUser = await UserManager.GetUserAsync(userClaimsPrincipal);
        }

        if (appUser != null && userClaimsPrincipal.IsInRole("Cliente"))
            ListaPaquetes = await paquetesService.Listar(p => p.PaqueteId > 0 && p.ClienteId == appUser.Id);
        else
            ListaPaquetes = await paquetesService.Listar(p => p.PaqueteId > 0);
    }

    private void AbrirModalEdicion(Paquetes paqueteOriginal)
    {
        PaqueteEnEdicion = new Paquetes
        {
            PaqueteId = paqueteOriginal.PaqueteId,
            ClienteId = paqueteOriginal.ClienteId,
            NumeroRecepcion = paqueteOriginal.NumeroRecepcion,
            NumeroTracking = paqueteOriginal.NumeroTracking,
            NumeroEPS = paqueteOriginal.NumeroEPS,
            Suplidor = paqueteOriginal.Suplidor,
            Contenido = paqueteOriginal.Contenido,
            Peso = paqueteOriginal.Peso,
            Total = paqueteOriginal.Total,
            CondicionEspecial = paqueteOriginal.CondicionEspecial,
            Categoria = paqueteOriginal.Categoria,
            Retenido = paqueteOriginal.Retenido,
            EstatusPaquete = paqueteOriginal.EstatusPaquete.ToList()
        };

        mostrarModalEdicion = true;
    }

    private void ActualizarPaquete()
    {
        EstatusPaqueteDetalles EstatusPaquete = new EstatusPaqueteDetalles();
        EstatusPaquete.EstatusPaqueteId = PaqueteEnEdicion.EstatusPaquete.Count() + 1;
        PaqueteEnEdicion.EstatusPaquete.Add(EstatusPaquete);
        actualizado = false;
    }

    private void CerrarModal()
    {
        PaqueteEnEdicion = new Paquetes();
        mostrarModalEdicion = false;
        actualizado = true;
    }

    private async Task GuardarCambiosPaquete()
    {
        var guardado = await paquetesService.Guardar(PaqueteEnEdicion);

        if (guardado)
        {
            mostrarModalEdicion = false;
            await CargarPaquetes();
        }
    }

    private string GetStatusColor(string status)
    {
        return "#78BE42"; // Ejemplo básico
    }
}