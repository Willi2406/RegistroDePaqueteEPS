@page "/cuenta/direcciones/upsert/{DireccionDeliveryId:int}"
@inject DireccionesDeliveryService direccionesDeliveryService
@inject AutorizadosEntregaService autorizadosEntregaService
@inject NavigationManager NavManager
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@rendermode InteractiveServer

<SectionContent SectionName="TituloPagina">
    <h1>CUENTA</h1>
</SectionContent>

<div class="glass-container">

    <div class="sub-nav-bar">
        <NavLink class="sub-nav-item" href="/cuenta">Perfil</NavLink>
        <div class="separator"></div>
        <NavLink class="sub-nav-item active" href="/cuenta/direcciones">Direcciones</NavLink>
        <div class="separator"></div>
        <NavLink class="sub-nav-item" href="/cuenta/autorizados">Autorizados</NavLink>
    </div>

    <div class="form-content">
        <h3 class="section-title">@Estado Dirección</h3>

        <EditForm Model="Direccion" OnValidSubmit="GuardarDireccion">
            <DataAnnotationsValidator />

            <div class="form-grid">

                <div class="form-item">
                    <label>Provincia</label>
                    <input type="text" class="input-box"
                           @bind-value="Direccion.Provincia"
                           placeholder="Provincia" />
                </div>

                <div class="form-item">
                    <label>Municipio</label>
                    <input type="text" class="input-box"
                           @bind-value="Direccion.Municipio"
                           placeholder="Ciudad" />
                </div>

                <div class="form-item">
                    <label>Sector</label>
                    <input type="text" class="input-box"
                           @bind-value="Direccion.Sector"
                           placeholder="Sector" />
                    <ValidationMessage For="@(() => Direccion.Sector)" />
                </div>

                <div class="form-item">
                    <label>Calle</label>
                    <input type="text" class="input-box"
                           @bind-value="Direccion.Calle"
                           placeholder="Calle Principal" />
                    <ValidationMessage For="@(() => Direccion.Calle)" />
                </div>

                <div class="form-item">
                    <label>Domicilio</label>
                    <input type="text" class="input-box"
                           @bind-value="Direccion.Domicilio"
                           placeholder="#123" />
                </div>

                <div class="form-item">
                    <label>Referencias</label>
                    <input type="text" class="input-box"
                           @bind-value="Direccion.Referencias"
                           placeholder="Cerca de..." />
                    <ValidationMessage For="@(() => Direccion.Referencias)" />
                </div>

                <div class="form-item">
                    <label>Transportista</label>
                    <select class="input-box" @bind="Direccion.AutorizadoEntregaId">
                        <option selected disabled value="">Seleccione...</option>
                        @foreach (AutorizadosEntrega autorizado in AutorizadosEntrega)
                        {
                            <option value="@autorizado.AutorizadoEntregaId">@autorizado.Nombres</option>
                        }
                    </select>
                </div>

                <div class="form-item">
                    <label>Alias (Ej: Casa, Oficina)</label>
                    <input type="text" class="input-box"
                           @bind-value="Direccion.Alias"
                           placeholder="Nombre de la dirección" />
                    <ValidationMessage For="@(() => Direccion.Alias)" />
                </div>
            </div>

            <div class="options-row">
                <div class="checkbox-group">
                    <label class="switch">
                        <InputCheckbox @bind-Value="Direccion.Principal" />
                        <span class="slider round"></span>
                    </label>
                    <span class="checkbox-label">Dirección Principal</span>
                </div>
            </div>

            <div class="action-buttons">
                <a href="/cuenta/direcciones" class="btn-cancel">Cancelar</a>
                <button type="submit" class="btn-save">Guardar</button>
            </div>

        </EditForm>
    </div>

</div>

@code {
    [Parameter]
    public int DireccionDeliveryId { get; set; }
    public DireccionesDelivery Direccion { get; set; } = new DireccionesDelivery();
    public string Estado { get; set; } = "Agregar";
    private ApplicationUser appUser;
    public List<AutorizadosEntrega> AutorizadosEntrega { get; set; } = new List<AutorizadosEntrega>();

    protected override async Task OnInitializedAsync()
    {
        AutorizadosEntrega = await autorizadosEntregaService.Listar(a => a.AutorizadoEntregaId > 0);
        if (DireccionDeliveryId > 0)
        {
            Estado = "Editar";
            Direccion = await direccionesDeliveryService.Buscar(DireccionDeliveryId);
        }
    }

    private async Task GuardarDireccion()
    {
        if (DireccionDeliveryId == 0)
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userClaimsPrincipal = authState.User;

            if (userClaimsPrincipal.Identity.IsAuthenticated)
            {
                appUser = await UserManager.GetUserAsync(userClaimsPrincipal);
            }

            Direccion.ClienteId = appUser.Id;
        }

        var modificado = await direccionesDeliveryService.Guardar(Direccion);
        if (modificado)
            NavManager.NavigateTo("/cuenta/direcciones");
    }
}