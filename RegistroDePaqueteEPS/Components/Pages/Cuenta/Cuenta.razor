@page "/cuenta"
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject SignInManager<ApplicationUser> SignInManager
@inject NavigationManager navigationManager
@rendermode InteractiveServer

<SectionContent SectionName="TituloPagina">
    <h1>CUENTA</h1>
</SectionContent>

<div class="glass-container">

    <div class="sub-nav-bar">
        <NavLink class="sub-nav-item active" href="/cuenta">Perfil</NavLink>
        <div class="separator"></div>

        <NavLink class="sub-nav-item" href="/cuenta/direcciones">Direcciones</NavLink>
        <div class="separator"></div>

        <NavLink class="sub-nav-item" href="/cuenta/autorizados">Autorizados</NavLink>
    </div>

    <h3 class="section-title">Datos Personales</h3>

    <div class="form-grid">

        <div class="form-item">
            <label>Usuario</label>
            <InputText class="data-box" @bind-Value="appUser.UserName" disabled />
        </div>

        <div class="form-item">
            <label>Sucursal</label>
            <InputText class="data-box" @bind-Value="appUser.Municipio" disabled/>
        </div>

        <div class="form-item">
            <label>Nombre</label>
            <InputText class="data-box" @bind-Value="appUser.NombreCompleto" disabled/>
        </div>

        <div class="form-item">
            <label>Cédula</label>
            <InputText class="data-box" @bind-Value="appUser.Identificacion" disabled/>
        </div>

        <div class="form-item">
            <label>Correo</label>
            <InputText class="data-box" @bind-Value="appUser.Email" />
        </div>

        <div class="form-item">
            <label>Teléfono</label>
            <InputText class="data-box" @bind-Value="appUser.PhoneNumber" />
        </div>
    </div>

    <div class="action-buttons">
        <button class="btn-save" @onclick="GuardarCambiosAsync">Guardar Cambios</button>
    </div>
</div>
@code
{
    private ApplicationUser? appUser;

    protected override async Task OnInitializedAsync()
    {
        // 1. Obtener el estado de autenticación (los claims)
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userClaimsPrincipal = authState.User;

        if (userClaimsPrincipal.Identity.IsAuthenticated)
        {
            // 2. Usar el UserManager para buscar el usuario completo en la BD
            // Este método usa internamente el ID del ClaimsPrincipal para buscar
            appUser = await UserManager.GetUserAsync(userClaimsPrincipal);
        }
    }

    private async Task GuardarCambiosAsync()
    {
        // 1. Verificar que el objeto appUser no sea null.
        if (appUser == null)
        {
            return;
        }

        var result = await UserManager.UpdateAsync(appUser);

        if (result.Succeeded)
        {
            await SignInManager.RefreshSignInAsync(appUser);

            navigationManager.NavigateTo(navigationManager.Uri, forceLoad: true);
        }
        else
        {
            Console.WriteLine("Error al guardar cambios:");
            foreach (var error in result.Errors)
            {
                Console.WriteLine($"- {error.Description}");
            }
        }
    }
}